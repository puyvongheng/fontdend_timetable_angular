



<div class="container mt-4  absolute" style="background-color: white; border-radius: 10px; padding: 20px;
 box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
<nz-card style="width:100%;" nzTitle="teacher" [nzExtra]="extraTemplate">





<!-- Add New Teacher Button and layout ui change -->
<div style="background-color: white; padding: 20px; border-radius: 10px;">
    <div  style="display: flex; justify-content: space-between;  "> 
        <div >
            <button   class="w-auto   me-1" nz-button nzType="primary"  nzShape="round" (click)="openEditModal()"   > add</button>
             
             <nz-select class="w-auto  me-1" nzShowSearch nzAllowClear nzPlaceHolder="year" name="year"
                     [(ngModel)]="selectedYear" (ngModelChange)="loadTeachers(); loadteachers()" required>
                     <nz-option *ngFor="let year of years" [nzLabel]="year" [nzValue]="year"></nz-option>
             </nz-select>

             <nz-select class="w-auto  me-1" nzShowSearch nzAllowClear nzPlaceHolder="semesters" name="semesters"
                        [(ngModel)]="selectedSemester" (ngModelChange)="loadTeachers(); loadteachers()" required>
                        <nz-option *ngFor="let semester of semesters"  [nzLabel]="semester" [nzValue]="semester"></nz-option>
             </nz-select>
        </div>
            <p-selectbutton [options]="table" [(ngModel)]="view" [multiple]="false" optionLabel="name" optionValue="value"
                    style="flex-shrink: 0;" size="small">
            </p-selectbutton>
    </div>
</div>






<!--table pro-->
   
<!-- TablePro View  ngPrimeng -->
        <p-table 
            #dt 
            dataKey="teacher.username"
            *ngIf="view === 'tablepro'" 
            [value]="teachers" 
            [paginator]="true" 
            [rows]="5" 
            [tableStyle]="{ 'min-width': '50rem' }" 
            [size]="'small'"
            [showCurrentPageReport]="true" 
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
            [rowsPerPageOptions]="[5, 10, 20 , teachers.length]"
            [globalFilterFields]="[ 'id','username' ,'name' ,'role'] ">


                <ng-template #caption>
                    <div class="flex">
                        <p-iconfield iconPosition="left" class="ml-auto">
                            <p-inputicon>
                                <i class="pi pi-search"></i>
                            </p-inputicon>
                            <input pInputText type="text" (input)="applyFilterGlobal($event, 'contains')" placeholder="Search " />
                
    
                        </p-iconfield>
                    </div>
                </ng-template>

                
            <ng-template pTemplate="header">
                <tr>
                    <th class="w-auto" pSortableColumn="id">ID <p-sortIcon field="id" /></th>
                    <th style="width:20%" pSortableColumn="username"> username <p-sortIcon field="username" /></th>
                    <th style="width:20%" pSortableColumn="name">name <p-sortIcon field="name" /></th>
                    <th class="w-auto" pSortableColumn="role">role <p-sortIcon field="role" /></th>
                    <th class="w-auto" pSortableColumn="number_sessions" >max_se <p-sortIcon field="number_sessions" /></th>
                    <th class="w-auto"> ម៉ោងបង្រៀន</th>
                    <th class="w-auto">មុខវិជ្ជា</th>
                    <th class="w-auto text-sm-center">Action</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-teacher>
                <tr>
                    <td>{{ teacher.id }}</td>
                    <td>{{ teacher.username }}</td>
                    <td>{{ teacher.name }}</td>
                    <td>{{ teacher.role }}</td>
                    <td>{{ teacher.number_sessions }}</td>
                    <td><p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true"  (click)="showModal_teacher_teaching_time();fetchTeacherTeachingTimes(teacher.id)" /></td>
                    <td><p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true" (click)="showModalsubject(teacher.id)" /></td>

                    <td class="d-flex justify-content-center align-items-center">
                        <p-button class="ms-4 mr-2"  icon="pi pi-pencil"  [rounded]="true" [outlined]="true"(click)="openEditModal(teacher)" />
                        <p-button  class="ms-4" icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true"(click)="deleteTeacher(teacher.id)" />
                    </td>
                </tr>
            </ng-template>
        </p-table>




<!-- Card View -->
        <div *ngIf="view === 'card'" class="card-container">
            <div *ngFor="let teacher of teachers" class="card">
                <div class="card-header">
                    <div style="display: flex; justify-content: center; align-items: center;">
                        <nz-avatar class="align-content-center justify-content-center" [nzSize]="64"
                            [nzSrc]="'https://cdn-icons-png.flaticon.com/512/1089/1089129.png'"></nz-avatar>
                    </div>
                    <br>
                    <h3 style="color:rgb(101,183,255);">{{ teacher.name }}</h3>
                    <p>{{ teacher.username }}</p>

                    <nz-progress [nzPercent]="(teacher.totalTimetable / teacher.number_sessions) * 100" nzStatus="active" nzSize="small"
                        [nzStrokeColor]="getStrokeColor((teacher.totalTimetable / teacher.number_sessions) * 100)">
                    </nz-progress>
                </div>

                <div class="card-body">
                        <ul class="list-unstyled">
                            <li *ngFor="let subject of findSubject(teacher?.id); let i = index"
                                [ngStyle]="{ color: subject.subject_name === 'No subjects' ? 'red' : 'inherit' }">
                                <!-- Conditionally hide index for the 'No subjects found' message -->
                                <span *ngIf="subject.subject_name !== 'No subjects'">
                                    {{ i + 1 }}.
                                </span>

                                : {{ subject.subject_name }}
                                <p *ngIf="subject.subject_name !== 'No subjects'"
                                    style="color: red; cursor: pointer; display: inline; margin-left: 10px; font-size: small;"
                                    (click)="removeSubjectFromTeacher(teacher?.id, subject.id)">
                                    <i class="fa fa-trash-o" aria-hidden="true"></i>
                                </p>
                            </li>
                        </ul>
                            <!-- មុខវិជ្ជារបស់គ្រូ  -->
                        <div>
                            <label for="subject" hidden>ជ្រើសរើស មុខវិជ្ជា:</label>
                            <select id="subject" (change)="onSubjectSelect($event, teacher?.id)" class="border-0">
                                <option value="">-- ជ្រើសរើស មុខវិជ្ជា --</option>
                                <option *ngFor="let subject of subjects" [value]="subject.id">{{ subject.name }}</option>
                            </select>

                            <button class=" Assign" *ngIf="selectedSubjectId[teacher?.id]"
                                (click)="assignSubjectToTeacher(teacher?.id, selectedSubjectId[teacher?.id])">
                                Assign មុខវិជ្ជា {{ findSubjectName(selectedSubjectId[teacher?.id]) }}
                            </button>
                        </div>

                    <br>

                    totalTimetable
            {{ teacher.totalTimetable }}
                    {{teacher.number_sessions}}

          <nz-tag>ម៉ោងបង្រៀន {{ teacher.totalTimetable }} /{{teacher.number_sessions}} </nz-tag> 
            <i class="fa fa-edit" aria-hidden="true"></i>
        <br>
            <div class="text-danger" *ngIf="teacher.totalTimetable-teacher.number_sessions  > -0">
                គាត់អស់ម៉ោងបង្រៀន 
            </div>
<br>






            <nz-tag>ម៉ោងដែលអាចបង្រៀន </nz-tag>

            <i class="fa fa-edit" 

                    nz-tooltip
                nzTooltipTitle="កែប្រែ វេនបង្រៀន"
            aria-hidden="true"   (click)="showModal_teacher_teaching_time();fetchTeacherTeachingTimes(teacher.id)"></i>
        </div>
                <div class="card-footer">
                    <style>
                        .Assign {
                            background-color: rgb(101, 183, 255);
                            /* Green color */
                            color: white;
                            border: none;
                            border-radius: 0px;
                            cursor: pointer;
                        }

                        .admin-role {
                            background-color: rgba(179, 225, 53, 0.527);
                            color: white;
                            /* Light blue background for admin */

                        }

                        .simple-role {
                            background-color: #fff1f0;
                            /* Light red background for simple */

                        }



                        /* Common styles for both icons */
                        .action-icon {
                            display: inline-block;
                            padding: 10px;
                            margin-right: 2px;
                            /* Rounded corners for the box */
                            transition: background-color 0.3s, transform 0.3s;
                            /* Smooth transition for hover effects */
                            cursor: pointer;
                        }

                        /* Edit icon styles */
                        .edit-icon {
                            /* Initial blue color */
                            color: rgb(0, 0, 0);
                        }

                        .edit-icon:hover {
                            background-color: rgb(0, 140, 200);
                            /* Darker blue when hovered */
                            transform: scale(1.1);
                            /* Slight zoom effect */
                        }

                        /* Delete icon styles */
                        .delete-icon {
                            /* Initial red color */
                            color: rgb(0, 0, 0);
                        }

                        .delete-icon:hover {
                            background-color: rgb(220, 0, 0);
                            /* Darker red when hovered */
                            transform: scale(1.1);
                            /* Slight zoom effect */
                        }

                        /* Optional: Style icons inside the box */
                        .action-icon i {
                            font-size: 18px;
                            /* Adjust the size of the icon */
                            transition: transform 0.3s;
                        }

                        /* Optional: When hovered, make the icon itself slightly larger */
                        .action-icon:hover i {
                            transform: scale(1.2);
                        }
                    </style>
                    <select [(ngModel)]="teacher.role" style=" margin-right: 20px; border-radius: 2px;" class="border-0"
                        [ngClass]="{'admin-role': teacher.role === 'admin', 'simple-role': teacher.role === 'simple'}"
                        (change)="Updaterole(teacher.id, teacher.role)">

                        <option value="admin">Admin</option>
                        <option value="simple">Simple</option>
                    </select>

                    <i class="action-icon edit-icon" (click)="openEditModal(teacher)">
                        <i class="fa fa-pencil" aria-hidden="true"></i>
                    </i>
                    

                    <i class="action-icon delete-icon" (click)="deleteTeacher(teacher.id)">
                        <i class="fa fa-trash-o" aria-hidden="true"></i>
                    </i>

                </div>


            </div>
        </div>

    





    </nz-card>


        <ng-template #extraTemplate>
            <div class="view-toggle">
            
                <button (click)="toggleView('card')" [ngClass]="{'active': view === 'card'}">
                    <i class="fa fa-th-large"></i> Card
                </button>
                <button (click)="toggleView('tablepro')" [ngClass]="{'active': view === 'tablepro'}">
                    <i class="fa fa-table"></i> Table
                </button>
            </div>
        </ng-template>


</div>














<style>
    /* Add New Teacher Button */
    .add-teacher-container {
        margin-bottom: 20px;
    }

    .add-teacher-container button {
        padding: 10px 20px;
        background-color: rgb(101, 183, 255);
        /* Green color */
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .add-teacher-container button:hover {
        background-color: rgb(101, 183, 255);
        /* Darker green on hover */
    }




    /* Card View */
    .card-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }

    .card {
        border: 1px solid #ddd;
        border-radius: 8px;
        width: 300px;
        padding: 15px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        border-bottom: 1px solid rgb(101, 183, 255);
        padding-bottom: 10px;
        margin-bottom: 10px;
    }

    .card-body {
        margin-bottom: 10px;
    }

    .card-footer {
        display: flex;
        justify-content: flex-end;
    }

    /* Modal Styling */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        width: 400px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
    }
</style>


<!--model input edet teaching _time -->
    <nz-modal  nzClassName="custom-modal" 
        [nzFooter]="null"
        [nzTitle]="undefined"
        [(nzVisible)]="isVisible_teacher_teaching_time"
        nzTitle="ម៉ោងបង្រៀន  id:{{selectedTeacherId}}" 
        (nzOnCancel)="handleCancel()"
        nzWidth="80%"
         (nzOnOk)="handleOk()">
        <ng-container *nzModalContent>
     




    <button  (click)="submitStudySessions(selectedTeacherId!)">បង្រៀន</button>
    <button (click)="submitDeleteStudySessions(selectedTeacherId!)">មិនអាចបង្រៀន</button>

    <style>
        table {
  font-family: sans-serif;
  font-size: 0.8rem;
  /*
  letter-spacing: 10px;*/
}

th,
td {
  border: 1px solid rgb(0, 0, 0);

}
th,
td,
td:last-of-type {
  text-align: center;
  


}
    </style>

            <table class="table">
                <thead>
                    <tr>
                        <th style="color: rgb(255, 26, 129);">Session Time</th>
                        <th>Monday</th>
                        <th>Tuesday</th>
                        <th>Wednesday</th>
                        <th>Thursday</th>
                        <th>Friday</th>
                        <th>Saturday</th>
                        <th>Sunday</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let timeSlotData of timeSlotSessions">
                        <td>{{ timeSlotData.timeSlot }}</td>
                        <ng-container *ngFor="let day of daysOfWeek">
                            <td *ngIf="timeSlotData.days[day]; else emptyCell"  >

                                <div class="session-cell ">

                              <!--
                                    {{timeSlotData.id}}
                                        {{ timeSlotData.days[day].shift_name }}

                                        {{ timeSlotData.days[day].id }}
-->

                                            <label nz-checkbox [(ngModel)]="timeSlotData.days[day].selected" style="width: 100%; height: 100%;" >

                                                <p *ngIf="checkIfSessionAssigned(timeSlotData.days[day].id)" style="color: green;">
                                                    បង្រៀន
                                                </p>
                                                <p *ngIf="!checkIfSessionAssigned(timeSlotData.days[day].id)" style="color: rgb(201, 0, 0);">
                                                    មិនអាចបង្រៀន
                                                </p>

                                            </label>
                                
                                </div>

                            </td>
                            <ng-template #emptyCell>
                                <td class="empty-session-cell">
            
            
                                </td>
                            </ng-template>
                        </ng-container>
                    </tr>
                </tbody>
            </table>
        </ng-container>
    </nz-modal>




<!--modele create  and edit-->

    <nz-modal
     nzClassName="custom-modal" 
        [nzFooter]="null"
        [nzTitle]="undefined"
     nzWidth="50%" [(nzVisible)]="isVisible2" nzTitle="​  {{ isEditMode ? 'Edit Teacher' : 'Add Teacher' }}" (nzOnCancel)="closeModal()" (nzOnOk)="saveEdit()">
        <ng-container *nzModalContent>
            <form [formGroup]="teacherForm" (ngSubmit)="isEditMode ? saveEdit() : onSubmit()">
               
           

                <!-- Name Field -->
                <div class="mb-3">
                    <label for="name" class="form-label">Name:</label>
                    <input id="name" formControlName="name" class="form-control" />
    
                    <!-- Validation Message for Name -->
                    <div *ngIf="teacherForm.get('name')?.touched && teacherForm.get('name')?.invalid" class="text-danger">
                        <small *ngIf="teacherForm.get('name')?.hasError('required')">Name is required.</small>
                    </div>
                </div>


                    <!-- Username Field -->
                    <div class="mb-3">
                        <label for="username" class="form-label">Username:</label>
                        <input id="username" formControlName="username" class="form-control" />
                    
                        <!-- Validation Message for Username -->
                        <div *ngIf="teacherForm.get('username')?.touched && teacherForm.get('username')?.invalid" class="text-danger">
                            <small *ngIf="teacherForm.get('username')?.hasError('required')">Username is required.</small>
                            <small *ngIf="teacherForm.get('username')?.hasError('minlength')">Username must be at least 4
                                characters.</small>
                        </div>
                    </div>
    
                <!-- Password Field -->
                <div class="mb-3">
    
    
                    <label for="password" class="form-label me-2">Password:</label>
                    <div class="mb-3 d-flex align-items-center">
                        <input id="password" type="text" formControlName="password" class="form-control me-2" />
                        <button type="button" (click)="generatePassword()" class="btn btn-info">Generate</button>
                    </div>
    
                    <!-- Validation Message for Password -->
                    <div *ngIf="teacherForm.get('password')?.touched && teacherForm.get('password')?.invalid"
                        class="text-danger">
                        <small *ngIf="teacherForm.get('password')?.hasError('required')">Password is required.</small>
                        <small *ngIf="teacherForm.get('password')?.hasError('minlength')">Password must be at least 8
                            characters long.</small>
                        <small *ngIf="teacherForm.get('password')?.hasError('passwordStrength')">Password must contain at
                            least one number and one uppercase letter.</small>
                    </div>
                </div>
                <label for="number_sessions" class="form-label me-2">number_sessions:</label>
                <div class="mb-3 d-flex align-items-center">
                    <input id="number_sessions" type="number" formControlName="number_sessions" class="form-control me-2" />
                </div>
    
    
                <!--  Role Field -->
                <div class="mb-3">
    
                    <label for="role" class="form-label">Role:</label>
                    <select id="role" formControlName="role" class="form-select">
                        <option value="admin">Admin</option>
                        <option value="simple">Simple</option>
                    </select>
    
                    <!-- Validation Message for Role -->
                    <div *ngIf="teacherForm.get('role')?.touched && teacherForm.get('role')?.invalid" class="text-danger">
                        <small *ngIf="teacherForm.get('role')?.hasError('required')">Role is required.</small>
                    </div>
    
                </div>
    
    
                <!-- Success or Error Message -->
                <div *ngIf="submissionSuccess" class="alert alert-success mt-3">
                    Teacher added/updated successfully!
                </div>
                <div *ngIf="submissionError" class="alert alert-danger mt-3">
                    {{ submissionError }}
                </div>

    
    
                <button type="submit" class="btn btn-primary" [disabled]="teacherForm.invalid">
                    {{ isEditMode ? 'update' : 'Add Teacher' }}
                </button>
    
    
                <button type="button" (click)="closeModal()" class="btn btn-secondary ms-2">Cancel</button>
    
    
            </form>
    
    
    
        </ng-container>
    </nz-modal>













<!-- 
             nzClassName="custom-modal"
    
        [nzTitle]="undefined" Hide the header/title -->
<!-- [nzFooter]="null"  Hide the footer -->


<style>
    ::ng-deep .custom-modal .ant-modal-content {
        border-radius: 20px;
        padding: 50px 50px 20px 20px;

    }
</style>

<!-- Modal for Assigning Subjects to Teachers -->



        <nz-modal    nzClassName="custom-modal" 
        [nzFooter]="null"
        [nzTitle]="undefined"

         [(nzVisible)]="isVisiblesubject"
         (nzOnCancel)="handleCancelsubject()"
            (nzOnOk)="handleOksubject()">
            <ng-container *nzModalContent>
                <div>
        
                    <ul class="list-unstyled  ">
                        <li *ngFor="let subject of findSubject(id_teacher); let i = index"
                            [ngStyle]="{ color: subject.subject_name === 'No subjects' ? 'red' : 'inherit' }">


<table class="table">
                <tr >
                    <td >
                        <span *ngIf="subject.subject_name !== 'No subjects'">{{ i + 1 }}.</span>
                    </td>

                    <td >: {{ subject.subject_name }}</td>
                    <td> 
                                    <p *ngIf="subject.subject_name !== 'No subjects'"
                                        style="color: red; cursor: pointer; display: inline; margin-left: 10px; font-size: small;"
                                        (click)="removeSubjectFromTeacher(id_teacher, subject.id)">
                                        <i class="fa fa-trash-o" aria-hidden="true"></i>
                                    </p>
                    </td>
                </tr>
</table>

                        </li>
                    </ul>
                    <!-- មុខវិជ្ជារបស់គ្រូ  -->
                    <div>

                            <!--
                        <label for="subject" hidden>ជ្រើសរើស មុខវិជ្ជា:</label>
                        
                        <select id="subject" (change)="onSubjectSelect($event, id_teacher)" class="border-0">
                            <option value="">-- ជ្រើសរើស មុខវិជ្ជា --</option>
                            <option *ngFor="let subject of subjects" [value]="subject.id">{{ subject.name }}</option>
                        </select>
-->



                            <nz-select class="w-100 mb-2" nzShowSearch name="subjectSelect"
                             [(ngModel)]="selectedSubjectId[id_teacher]" (change)="onSubjectSelect($event, id_teacher)"

                               nzAllowClear
                                nzPlaceHolder="ជ្រើសរើស មុខវិជ្ជា:" [nzOptions]="subjectsGroup">
                            </nz-select>

        
                        <button class=" Assign" *ngIf="selectedSubjectId[id_teacher]"
                            (click)="assignSubjectToTeacher(id_teacher, selectedSubjectId[id_teacher])">
                            Assign មុខវិជ្ជា {{ findSubjectName(selectedSubjectId[id_teacher]) }}
                        </button>



        
                    </div>
                </div>
        
        
            </ng-container>
        </nz-modal>